# -*- coding: utf-8 -*-
import matplotlib.pyplot as plt
import numpy as np

# 1) 横轴刻度（每个任务可以有不同的横坐标值）
kv_budgets = {
    "AIME24": [64, 128, 256, 512, 1024, 2048, 4096],
    "MATH-500": [64, 128, 256, 512, 1024, 2048],
    "LiveCodeBench": [64, 128, 256, 512, 1024, 2048, 4096],
    "GPQA": [64, 128, 256, 512, 1024, 2048],
}

# 2) 数据组织方式：
# datasets -> models -> { 'full_cache': float,
#                         'StreamingLLM': [y1..y5],
#                         'H2O': [y1..y5],
#                         'D2O': [y1..y5] }
#
# ⚠️把下面的示例数值替换为你的真实结果即可。
data = {
    "AIME24": {
        "R1-Qwen-7B": {
            "full_cache": 55.5,
            "H2O":          [0.2, 0.6, 3.8, 18.5, 37.2, 42.8, 55.1],
            "D2O":          [0.4, 1.6, 4.9, 33.4, 44.7, 49.3, 55.5],
            "RaaS":         [0.5, 2.0, 5.8, 37.2, 47.5, 52.1, 55.5],
            "SnapKV":       [0.3, 1.4, 4.5, 31.4, 43.3, 48.0, 55.5],
            "R-KV":         [0.8, 5.4, 19.0, 45.8, 53.1, 55.5, 55.5],
            "Ours":         [1.0, 6.5, 21.3, 48.5, 54.6, 55.5, 55.5],
        },
        "R1-Qwen-14B": {
            "full_cache": 69.7,
            "H2O":          [0.4, 6.2, 9.4, 36.5, 52.4, 59.1, 69.7],
            "D2O":          [0.5, 5.8, 8.7, 48.2, 56.1, 61.8, 69.7],
            "RaaS":         [0.6, 6.3, 9.8, 53, 59.6, 65.4, 69.7],
            "SnapKV":       [0.4, 5.5, 8.2, 45.7, 54.3, 60.2, 69.7],
            "R-KV":         [1, 26.8, 40.2, 60, 66.7, 69.7, 69.7],
            "Ours":         [1.2, 28.9, 43, 63.4, 68.5, 69.7, 69.7],
        },
        "R1-Qwen-32B": {
            "full_cache":72.6,
            "H2O":          [0.6, 12.2, 22.4, 45.3, 62.1, 68.5, 72.6],
            "D2O":          [0.7, 12.8, 21.8, 57.2, 65.3, 70.2, 72.6],
            "RaaS":         [0.8, 13.5, 23.2, 62.1, 68.7, 72.0, 72.6],
            "SnapKV":       [0.6, 12.5, 22.1, 55.8, 63.9, 69.6, 72.6],
            "R-KV":         [1.1, 28.6, 45.9, 64.0, 71.1, 72.6, 72.6],
            "Ours":         [1.3, 30.8, 48.8, 67.6, 73.0, 72.6, 72.6],
        },
        "R1-Llama-8B": {
            "full_cache": 50,
            "H2O":          [0.4, 0.4, 6.7, 31.2, 33.6, 37.6, 50],
            "D2O":          [0.4, 0.4, 8.4, 33.6, 39.8, 50, 50],
            "RaaS":         [0.4, 0.4, 7, 33.6, 37.6, 50, 50],
            "SnapKV":       [0.4, 0.4, 7.5, 32.5, 38.7, 50, 50],
            "R-KV":         [0.5, 0.5, 13.8, 38.9, 46.7, 50, 50],
            "Ours":         [0.5, 0.5, 15.8, 41.7, 49.1, 50, 51.6],
        },
        "GPT-OSS-20B": {
            "full_cache": 73.33,
            "H2O":          [0.5, 0.9, 1.3, 40.7, 50.3, 63.3, 71.4],
            "D2O":          [0.6, 0.8, 14.2, 40.1, 56.8, 67.2, 72.1],
            "RaaS":         [0.7, 1, 16.6, 42.6, 59.2, 69.5, 73.33],
            "SnapKV":       [0.5, 0.7, 13.8, 39.5, 56.2, 66.8, 71.8],
            "R-KV":         [0.8, 26.8, 33.4, 54.33, 60.5, 73.33, 73.33],
            "Ours":         [0.8, 27.9, 34.6, 57.3, 62.5, 73.33, 73.33],
        },
        "QwQ-32B": {
            "full_cache": 79.5,
            "H2O":          [54, 60, 64, 68, 70, 69, 70],
            "D2O":          [55, 61, 65, 68, 70, 69, 70],
            "RaaS":         [58, 63, 66, 69, 70, 69, 70],
            "SnapKV":       [55, 60, 63, 67, 70, 69, 70],
            "R-KV":         [57, 62, 65, 68, 70, 69, 70],
            "Ours":         [62, 66, 68, 70, 70, 69, 70],
        },
        "Qwen3-30B": {
            "full_cache": 84.5,
            "H2O":          [0.8, 14.2, 25.6, 48.2, 65.3, 72.1, 76.8],
            "D2O":          [1.0, 15.8, 28.4, 56.8, 68.7, 74.2, 76.8],
            "RaaS":         [1.2, 16.5, 30.1, 59.3, 70.2, 75.6, 76.8],
            "SnapKV":       [0.9, 15.1, 27.8, 54.9, 67.8, 73.5, 76.8],
            "R-KV":         [1.3, 32.4, 47.2, 66.5, 74.8, 76.8, 76.8],
            "Ours":         [1.5, 34.8, 50.6, 70.2, 76.1, 76.8, 76.8],
        },
    },
    "LiveCodeBench": {
        "R1-Qwen-7B": {
            "full_cache": 37.6,
            "H2O":          [0.1, 0.3, 4.8, 14.2, 28.6, 34.8, 37.4],
            "D2O":          [0.3, 0.5, 7.8, 20.3, 30.7, 36.5, 37.6],
            "RaaS":         [0.2, 0.4, 8.2, 22.5, 31.2, 36.1, 37.6],
            "SnapKV":       [0.2, 0.3, 6.9, 19.1, 30.8, 36.6, 37.6],
            "R-KV":         [0.6, 0.9, 15.0, 29.0, 34.4, 37.6, 37.6],
            "Ours":         [0.8, 1.3, 16.4, 30.9, 36.0, 37.6, 37.6],
        },
        "R1-Qwen-14B": {
            "full_cache": 53.1,
            "H2O":          [0.4, 0.8, 12.2, 35.8, 50.7, 52.8, 53.1],
            "D2O":          [0.5, 0.9, 14.5, 38.2, 51.1, 52.9, 53.1],
            "RaaS":         [0.6, 1, 16.2, 42.3, 52.8, 53.0, 53.1],
            "SnapKV":       [0.4, 0.7, 13.8, 36.5, 50.3, 52.7, 53.1],
            "R-KV":         [0.8, 1.2, 25.4, 45.2, 52.8, 53.0, 53.1],
            "Ours":         [1.1, 1.8, 28.7, 47.8, 52.2, 53.0, 53.1],
        },
        "R1-Qwen-32B": {
            "full_cache": 57.2,
            "H2O":          [0.3, 0.7, 8.5, 32.1, 55.8, 57.2, 57.2],
            "D2O":          [0.4, 1.2, 18.3, 35.6, 56.4, 57.2, 57.2],
            "RaaS":         [0.5, 0.8, 22.7, 41.2, 55.9, 57.2, 57.2],
            "SnapKV":       [0.3, 0.6, 11.4, 28.7, 56.6, 57.2, 57.2],
            "R-KV":         [0.8, 1.5, 24.8, 43.2, 57.2, 57.2, 57.2],
            "Ours":         [1.1, 2.3, 33.4, 46.8, 57.2, 57.2, 57.2],
        },
        "R1-Llama-8B": {
            "full_cache": 32.14,
            "H2O":          [0.5, 1.2, 1.4, 11.8, 16.3, 21.8, 30.2],
            "D2O":          [0.8, 2.1, 3.6, 14.5, 19.2, 24.8, 31.8],
            "RaaS":         [0.9, 2.4, 3.2, 16.1, 22.8, 27.2, 32.0],
            "SnapKV":       [0.7, 2.0, 4.8, 15.8, 20.5, 25.0, 31.9],
            "R-KV":         [0.78, 2.34, 15.8, 20.67, 28.78, 30.14, 32.14],
            "Ours":         [1.0, 2.76, 18.4, 22.14, 29.97, 32.14, 32.14],
        },
        "GPT-OSS-20B": {
            "full_cache": 77.8,
            "H2O":          [0.4, 0.9, 1.3, 22.7, 25.6, 52.2, 77.8],
            "D2O":          [0.5, 0.8, 1.2, 24.2, 56.1, 67.8, 75.2],
            "RaaS":         [0.6, 1, 1.4, 26.5, 44.6, 60.4, 77.8],
            "SnapKV":       [0.4, 0.7, 1.1, 23.8, 55.5, 67.2, 74.8],
            "R-KV":         [0.8, 1.2, 22.5, 52.8, 64.4, 76.6, 77.8],
            "Ours":         [1, 1.5, 24.6, 54.8, 66.5, 75.6, 77.8],
        },
        "QwQ-32B": {
            "full_cache": 62.7,
            "H2O":          [22, 26, 29, 31, 32, 31, 32],
            "D2O":          [23, 27, 29, 31, 32, 31, 32],
            "RaaS":         [24, 28, 30, 31, 32, 31, 32],
            "SnapKV":       [21, 25, 28, 30, 32, 31, 32],
            "R-KV":         [23, 27, 29, 31, 32, 31, 32],
            "Ours":         [26, 29, 31, 32, 32, 31, 32],
        },
        "Qwen3-30B": {
            "full_cache": 66.0,
            "H2O":          [0.6, 1.2, 9.8, 34.5, 56.2, 58.7, 59.8],
            "D2O":          [0.8, 1.8, 20.4, 38.9, 57.8, 59.2, 59.8],
            "RaaS":         [0.9, 1.5, 24.8, 43.6, 58.1, 59.6, 59.8],
            "SnapKV":       [0.6, 1.1, 13.2, 31.8, 57.5, 59.0, 59.8],
            "R-KV":         [1.2, 2.1, 27.6, 45.8, 59.8, 59.8, 59.8],
            "Ours":         [1.5, 2.8, 36.2, 49.2, 59.8, 59.8, 59.8],
        },
    },
    "MATH-500": {
        "R1-Qwen-7B": {
            "full_cache": 92.8,
            "H2O":          [0.5, 2.3, 45.8, 68.2, 82.5, 92.8],
            "D2O":          [1.2, 12.8, 58.7, 82.4, 90.2, 92.8],
            "RaaS":         [0.8, 11.5, 56.3, 81.7, 89.8, 92.8],
            "SnapKV":       [1.1, 13.2, 57.9, 82.1, 90.1, 92.8],
            "R-KV":         [0.9, 42.8, 68.9, 87.3, 91.5, 93.2],
            "Ours":         [1.0, 44.5, 71.2, 88.7, 92.1, 94.1],
        },
        "R1-Qwen-14B": {
            "full_cache": 93.9,
            "H2O":          [1.5, 5.2, 58.3, 72.1, 86.5, 93.9],
            "D2O":          [2.3, 18.5, 68.7, 87.1, 93.2, 93.9],
            "RaaS":         [2.0, 17.0, 66.1, 86.1, 92.9, 93.9],
            "SnapKV":       [2.2, 17.8, 67.9, 86.8, 93.1, 93.9],
            "R-KV":         [2.1, 53.4, 74.8, 90.9, 93.9, 94.3],
            "Ours":         [2.1, 54.0, 76.7, 91.3, 94.6, 95.4],
        },
        "R1-Qwen-32B": {
            "full_cache": 94.3,
            "H2O":          [0.8, 3.2, 48.7, 65.8, 81.2, 94.3],
            "D2O":          [1.5, 12.4, 61.8, 79.5, 90.8, 94.3],
            "RaaS":         [1.2, 10.8, 58.3, 78.1, 89.5, 94.3],
            "SnapKV":       [1.4, 11.9, 60.1, 79.8, 90.2, 94.3],
            "R-KV":         [1.1, 38.4, 68.5, 86.7, 93.1, 94.7],
            "Ours":         [1.2, 42.8, 73.2, 89.4, 95.6, 96.8],
        },
        "R1-Llama-8B": {
            "full_cache": 89.1,
            "H2O":          [1.8, 6.5, 60.2, 72.7, 85.2, 89.1],
            "D2O":          [1.9, 15.2, 61.8, 79.4, 87.2, 89.1],
            "RaaS":         [1.9, 16.1, 62.7, 81.8, 88.2, 89.1],
            "SnapKV":       [1.8, 14.8, 61.1, 78.9, 87.2, 89.1],
            "R-KV":         [2, 50.7, 70.9, 86.2, 89.1, 89.6],
            "Ours":         [2, 51.2, 72.8, 86.7, 89.8, 90.5],
        },
        "GPT-OSS-20B": {
            "full_cache": 79.8,
            "H2O":          [1.4, 6.2, 52.8, 66.4, 75.9, 79.8],
            "D2O":          [1.9, 12.8, 56.7, 70.3, 78.6, 79.8],
            "RaaS":         [1.5, 15.1, 55.8, 72.8, 78.7, 79.8],
            "SnapKV":       [1.8, 12.7, 55.3, 69.9, 77.8, 79.8],
            "R-KV":         [2.1, 44.8, 64.2, 76.9, 79.5, 80.3],
            "Ours":         [2.0, 46.3, 64.8, 78.1, 80.1, 81.1],
        },
        "QwQ-32B": {
            "full_cache": 98.0,
            "H2O":          [40, 42, 44, 46, 48, 48],
            "D2O":          [40, 42, 45, 46, 48, 48],
            "RaaS":         [39, 43, 45, 47, 48, 48],
            "SnapKV":       [38, 41, 43, 45, 48, 48],
            "R-KV":         [40, 43, 45, 46, 48, 48],
            "Ours":         [43, 45, 47, 48, 48, 48],
        },
        "Qwen3-30B": {
            "full_cache": 97.2,
            "H2O":          [1.2, 4.8, 52.3, 68.9, 84.2, 95.2],
            "D2O":          [1.8, 14.2, 64.7, 81.3, 92.1, 95.2],
            "RaaS":         [1.5, 12.8, 61.9, 80.5, 91.8, 95.2],
            "SnapKV":       [1.7, 13.6, 63.2, 81.1, 92.0, 95.2],
            "R-KV":         [1.4, 41.8, 71.2, 88.6, 94.1, 95.2],
            "Ours":         [1.6, 45.2, 75.8, 91.2, 95.8, 96.4],
        },
    },
    "GPQA": {
        "R1-Qwen-7B": {
            "full_cache": 49.1,
            "H2O":          [0.8, 2.5, 12.8, 25.4, 38.9, 47.2],
            "D2O":          [1.2, 7.8, 21.1, 33.5, 44.8, 48.5],
            "RaaS":         [0.6, 7.2, 22.5, 36.8, 45.2, 48.1],
            "SnapKV":       [1.0, 8.9, 20.8, 32.1, 44.1, 48.3],
            "R-KV":         [1.3, 14.8, 29.8, 40.5, 46.8, 48.8],
            "Ours":         [1.8, 20.2, 33.4, 42.9, 47.9, 49.2],
        },
        "R1-Qwen-14B": {
            "full_cache": 59.1,
            "H2O":          [1.2, 4.8, 18.5, 35.2, 53.8, 58.1],
            "D2O":          [2.1, 12.7, 32.4, 44.6, 57.2, 59.0],
            "RaaS":         [1.1, 12.1, 32.5, 48.4, 56.6, 58.7],
            "SnapKV":       [1.8, 14.2, 31.8, 43.7, 56.4, 58.9],
            "R-KV":         [1.9, 21.9, 41.2, 52.1, 57.6, 58.9],
            "Ours":         [2.3, 29.2, 45.2, 55.1, 58.6, 59.4],
        },
        "R1-Qwen-32B": {
            "full_cache": 62.1,
            "H2O":          [0.9, 9.2, 24.8, 36.5, 53.7, 59.8],
            "D2O":          [1.6, 12.9, 36.3, 51.2, 57.2, 61.1],
            "RaaS":         [0.8, 11.1, 37.1, 52.4, 58.1, 60.7],
            "SnapKV":       [1.3, 12.7, 35.8, 52.8, 58.6, 61.0],
            "R-KV":         [1.5, 26.8, 45.2, 55.9, 58.8, 61.4],
            "Ours":         [2.0, 29.4, 49.6, 57.2, 59.9, 62.2],
        },
        "R1-Llama-8B": {
            "full_cache": 49.0,
            "H2O":          [0.8, 1.2, 18.3, 34.7, 45.2, 47.8],
            "D2O":          [1.0, 4.7, 25.1, 37.9, 47.6, 48.4],
            "RaaS":         [1.2, 7.3, 31.8, 44.2, 47.1, 48.7],
            "SnapKV":       [0.7, 4.8, 23.9, 35.8, 47.9, 48.1],
            "R-KV":         [1.1, 25.2, 41.4, 45.3, 48.5, 48.9],
            "Ours":         [1.3, 30.1, 38.7, 48.8, 48.3, 49.4],
        },
        "GPT-OSS-20B": {
            "full_cache": 71.5,
            "H2O":          [0.9, 3.2, 15.7, 36.1, 58.9, 67.3],
            "D2O":          [2.1, 11.4, 33.6, 48.2, 64.7, 69.8],
            "RaaS":         [1.3, 14.7, 39.3, 58.6, 68.4, 71.0],
            "SnapKV":       [0.7, 12.6, 31.1, 45.9, 62.8, 68.5],
            "R-KV":         [2.4, 28.9, 52.3, 63.1, 69.7, 71.2],
            "Ours":         [2.8, 35.4, 54.7, 66.8, 70.9, 71.8],
        },
        "QwQ-32B": {
            "full_cache": 65.6,
            "H2O":          [40, 43, 45, 47, 48, 48],
            "D2O":          [40, 43, 45, 47, 48, 48],
            "RaaS":         [41, 44, 46, 48, 48, 48],
            "SnapKV":       [39, 42, 44, 46, 48, 48],
            "R-KV":         [40, 43, 45, 47, 48, 48],
            "Ours":         [44, 46, 48, 48, 48, 48],
        },
        "Qwen3-30B": {
            "full_cache": 73.4,
            "H2O":          [1.1, 10.4, 27.2, 39.8, 56.4, 61.2],
            "D2O":          [1.8, 14.6, 38.9, 53.7, 59.8, 62.6],
            "RaaS":         [1.2, 13.2, 39.8, 55.1, 60.4, 62.1],
            "SnapKV":       [1.6, 14.1, 38.2, 54.6, 60.9, 62.3],
            "R-KV":         [1.8, 28.4, 47.8, 58.2, 61.5, 63.1],
            "Ours":         [2.2, 31.8, 52.1, 60.4, 62.8, 64.1],
        },
    },
}

# 3) 画图
datasets_order = ["AIME24", "MATH-500", "LiveCodeBench", "GPQA"]
models_order = ["R1-Qwen-7B", "R1-Qwen-14B", "R1-Qwen-32B", "R1-Llama-8B", "GPT-OSS-20B", "QwQ-32B", "Qwen3-30B"]

fig, axes = plt.subplots(
    nrows=len(datasets_order), ncols=len(models_order),
    figsize=(30, 15), sharex=False
)

# 统一的样式（不指定颜色，交由 Matplotlib 默认配色）
marker_map = {
    "H2O": "s",
    "D2O": "o",
    "RaaS": "^",
    "SnapKV": "v",
    "R-KV": "d",
    "Ours": "*",
}
linestyle_map = {
    "H2O": "-.",
    "D2O": "-",
    "RaaS": "--",
    "SnapKV": ":",
    "R-KV": "-",
    "Ours": "-",
}

# 用于放在整张图上的大图例
handles_for_legend = []
labels_for_legend = []

for r, ds in enumerate(datasets_order):
    for c, model in enumerate(models_order):
        ax = axes[r, c]
        series = data[ds][model]

        # Full Cache 虚线水平线
        fc = series["full_cache"]
        ax.axhline(fc, linestyle="--", linewidth=1.5, label="Full Cache")

        # 六条方法曲线
        for name in ["H2O", "SnapKV", "RaaS", "D2O", "R-KV", "Ours"]:
            y = series[name]
            x = range(len(kv_budgets[ds]))  # 使用等间隔的索引作为横坐标
            (ln,) = ax.plot(
                x, y,
                marker=marker_map[name], linestyle=linestyle_map[name],
                linewidth=2, markersize=5, label=name,
            )
            # 收集一次即可用于全局图例
            if r == 0 and c == 0:
                handles_for_legend.append(ln)
                labels_for_legend.append(name)

        # 设置横坐标刻度（等间隔位置，显示实际数值）
        ax.set_xticks(range(len(kv_budgets[ds])))
        ax.set_xticklabels(kv_budgets[ds])
        
        # 轴、标题
        if r == len(datasets_order) - 1:
            ax.set_xlabel("KV Cache Budget")
        if c == 0:
            # 前两行用 EM，最后一行用 bleu_acc（可按需改成你的指标名）
            ax.set_ylabel("Accuracy (%)")

        ax.set_title(f"{ds} {model}")
        ax.grid(True, alpha=0.3)

# 顶部合并图例（含 Full Cache 的虚线）
# 先手动创建一个与 axhline 样式一致的 Line2D 句柄
from matplotlib.lines import Line2D
full_cache_proxy = Line2D([0], [0], linestyle="--", linewidth=1.5, color="black")
handles = [full_cache_proxy] + handles_for_legend
labels = ["Full Cache"] + labels_for_legend

fig.legend(handles, labels, loc="upper center", ncol=7, frameon=False, fontsize=10)
plt.tight_layout(rect=[0, 0, 1, 0.98])  # 给顶部图例留空间
plt.show()
plt.savefig("exp_1.pdf", dpi=300, bbox_inches="tight")
